version: '3.8'

services:
  mindbot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mindbot-app
    restart: unless-stopped
    environment:
      # DingTalk Configuration
      - DINGTALK_CLIENT_ID=${DINGTALK_CLIENT_ID}
      - DINGTALK_CLIENT_SECRET=${DINGTALK_CLIENT_SECRET}
      - DINGTALK_ROBOT_CODE=${DINGTALK_ROBOT_CODE}
      - DINGTALK_ROBOT_NAME=${DINGTALK_ROBOT_NAME:-MindBot_poc}
      - DINGTALK_CARD_TEMPLATE_ID=${DINGTALK_CARD_TEMPLATE_ID:-c497adc7-0d7e-4662-976b-ab07b35332db.schema}
      
      # Dify Configuration
      - DIFY_API_KEY=${DIFY_API_KEY}
      - DIFY_BASE_URL=${DIFY_BASE_URL}
      - DIFY_WORKSPACE_ID=${DIFY_WORKSPACE_ID}
      
      # Qwen Configuration
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_BASE_URL=${QWEN_BASE_URL}
      - QWEN_MODEL=${QWEN_MODEL:-qwen3-0.6b}
      
      # OpenAI Configuration (optional)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      
      # Debug Configuration
      - DEBUG_MODE=${DEBUG_MODE:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # Streaming Configuration
      - ENABLE_STREAMING=${ENABLE_STREAMING:-true}
      - STREAMING_MIN_CHUNK_SIZE=${STREAMING_MIN_CHUNK_SIZE:-20}
      - STREAMING_UPDATE_DELAY=${STREAMING_UPDATE_DELAY:-0.05}
      - STREAMING_MAX_RETRIES=${STREAMING_MAX_RETRIES:-3}
      - STREAMING_RETRY_DELAY=${STREAMING_RETRY_DELAY:-1.0}
      - ENABLE_FLUID_STREAMING=${ENABLE_FLUID_STREAMING:-true}
      - FLUID_STREAMING_MIN_CHUNK=${FLUID_STREAMING_MIN_CHUNK:-10}
      - FLUID_STREAMING_DELAY=${FLUID_STREAMING_DELAY:-0.02}
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config
      - ./.env:/app/.env:ro
    networks:
      - mindbot-network
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  mindbot-network:
    driver: bridge 